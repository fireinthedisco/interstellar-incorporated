namespace = iicso

#called by yearly pulse gate event (semi-annually)
country_event = {
    id = iicso.500
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        log = "iicso.500 triggered, sending event to mining stations"
        every_planet = {
            limit = {
                NOT = { has_planet_flag = running_freighters }
                OR = {
                    AND = {
                        has_mining_station = yes
                        has_stockpile = yes
                    }
                    AND = {
                        is_primary_star = yes
                        has_stockpile = yes
                        solar_system = { exists = starbase }
                    }
                    # AND = {
                    #     is_colony = yes
                    #     NOT = { is_capital = yes }
                    # }
                }
            }
            planet_event = {
                id = iicso.501
                days = 1
                random = 179
            }
        }
    }
}

#called by iicso.500, calls itself
planet_event = {
    id = iicso.501
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        log = "system freighters triggered at [THIS.GetName] for empire [THIS.solar_system.space_owner.GetName]"
        if = {
            limit = {
                OR = {
                    solar_system = {
                        starbase = {
                            controller = { is_same_value = PREV.owner }
                        }
                    }
                    AND = {
                        is_colony = yes
                        controller = { is_same_value = PREV.owner }
                    }
                }
            }
            if = {
                limit = { has_sufficient_stockpile = yes }
                random_country = {
                    limit = { has_country_flag = civ_faction_of@PREV.space_owner }
    
                    if = {
                        limit = {
                            ROOT = {
                                is_primary_star = yes
                                solar_system = {
                                    starbase = { has_starbase_module = trading_hub }
                                }
                            }
                        }
                        create_fleet = {
                            name = hub_freighter_fleet
                            effect = {
                                set_owner = PREV
                                create_station_freighter_ships = yes
                                set_location = PREVPREV
                                set_fleet_flag = hub_freighter
                            }
                        }
                    }
                    else_if = {
                        limit = { ROOT = { is_primary_star = yes }}
                        create_fleet = {
                            name = system_freighter_fleet
                            effect = {
                                set_owner = PREV
                                create_station_freighter_ships = yes
                                set_location = PREVPREV
                                set_fleet_flag = system_freighter
                            }
                        }
                    }
                    else_if = {
                        limit = { ROOT = { is_colony = yes }}
                        create_fleet = {
                            name = colony_freighter_fleet
                            effect = {
                                set_owner = PREV
                                create_station_freighter_ships = yes
                                set_location = PREVPREV
                                set_fleet_flag = colony_freighter
                            }
                        }
                    }
                    else = {
                        create_fleet = {
                            name = station_freighter_fleet
                            effect = {
                                set_owner = PREV
                                create_station_freighter_ships = yes
                                set_location = PREVPREV
                                set_fleet_flag = station_freighter
                            }
                        }
                    }
                    last_created_fleet = {
                        set_fleet_stance = evasive
                        set_timed_fleet_flag = {
                            flag = orders_received
                            days = 90
                        }
                        if = {
                            limit = {
                                ROOT = {
                                    OR = {
                                        is_primary_star = yes
                                        is_colony = yes
                                    }
                                }
                            }
                            fleet_event = {
                                id = iicso.503
                                days = 5
                                random = 10
                            }
                        }
                        else = {
                            fleet_event = {
                                id = iicso.502
                                days = 5
                                random = 10
                            }
                        }
                    }
                }
            }
    
            set_timed_planet_flag = {
                flag = running_freighters
                days = 180
            }
            planet_event = {
                id = iicso.501
                days = 180
            }
        }
    }
}

#called by iicso.501, fleet auto move arrival (deactivated)
fleet_event = {
    id = iicso.502
    is_triggered_only = yes
    hide_window = yes

    trigger = {
        exists = FROM
    }

    immediate = {
        solar_system = {
            if = {
                limit = {
                    any_system_planet = {
                        is_colony = yes
                        controller = { is_same_value = PREV.owner }
                        NOT = { has_orbital_bombardment = yes }
                    }
                }
                
                random_system_planet = {
                    limit = {
                        is_colony = yes
                        controller = { is_same_value = PREV.owner }
                        NOT = { has_orbital_bombardment = yes }
                    }
                    weights = {
                        base = 1
                        modifier = {
                            mult = 2
                            is_capital = yes
                        }
                    }
                    ROOT = {
                        set_timed_fleet_flag = {
                            flag = orders_received
                            days = 120
                        }
                        if = {
                            limit = { PREV = { is_capital = yes }}
                            set_fleet_flag = enroute_to_capital@PREV
                        }
                        else = { set_fleet_flag = enroute_to_colony@PREV }
                        auto_move_to_planet = {
                            target = PREV
                            clear_auto_move_on_arrival = no
                            arrival_effect = deposit_cargo_at_colony
                        }
                    }
                }
            }
            else = {
                random_system_planet = {
                    limit = { is_primary_star = yes }
                    ROOT = {
                        set_timed_fleet_flag = {
                            flag = orders_received
                            days = 120
                        }
                        set_fleet_flag = enroute_to_starbase@PREV
                        auto_move_to_planet = {
                            target = PREV
                            clear_auto_move_on_arrival = no
                            arrival_effect = deposit_cargo_at_starbase
                        }
                    }
                }
            }
        }
    }
}

#called by iicso.501, on entering system fleet
fleet_event = {
    id = iicso.503
    is_triggered_only = yes
    hide_window = yes

    trigger = {
        OR = {
            has_fleet_flag = hub_freighter
            has_fleet_flag = system_freighter
            has_fleet_flag = station_freighter
            has_fleet_flag = colony_freighter
        }
        OR = {
            NOT = { has_fleet_flag = calculated_destination }
            solar_system = { any_system_planet = { PREVPREV = { has_fleet_flag = enroute_to_colony@PREV }}}
            solar_system = { any_system_planet = { PREVPREV = { has_fleet_flag = enroute_to_starbase@PREV }}}
            solar_system = { any_system_planet = { PREVPREV = { has_fleet_flag = enroute_to_capital@PREV }}}
        }
        OR = { #If the fleet IS a colony freighter, this event will only run if the capital becomes an invalid destination, or if the fleet is not headed for the capital
            NOT = { has_fleet_flag = colony_freighter }
            any_country = {
                has_country_flag = civ_faction@ROOT.owner
                OR = {
                    capital_scope = {
                        OR = {
                            NOT = { controller = { is_same_value = PREV.owner }}
                            has_orbital_bombardment = yes
                        }
                    }
                    NOT = { ROOT = { has_fleet_flag = enroute_to_capital@PREV.capital_scope }}
                }
            }
        }
    }

    immediate = {
        set_timed_fleet_flag = {
            flag = calculated_destination
            days = 120
        }
        random_country = {
            limit = { has_country_flag = civ_faction@ROOT.owner }
            ROOT = {
                if = {
                    limit = {
                        has_fleet_flag = colony_freighter
                        PREV = {
                            capital_scope = {
                                controller = { is_same_value = PREV.owner }
                                NOT = { has_orbital_bombardment = yes }
                            }
                        }
                        NOT = { has_fleet_flag = enroute_to_capital@PREV.capital_scope }
                    }
                    random_planet = {
                        limit = {
                            ROOT = {
                                OR = {
                                    has_fleet_flag = enroute_to_colony@PREV
                                    has_fleet_flag = enroute_to_starbase@PREV
                                    has_fleet_flag = enroute_to_capital@PREV
                                }
                            }
                        }
                        ROOT = {
                            remove_fleet_flag = enroute_to_colony@PREV
                            remove_fleet_flag = enroute_to_starbase@PREV
                            remove_fleet_flag = enroute_to_capital@PREV
                        }
                    }
                    if = {
                        limit = { has_auto_move_target = yes }
                        remove_auto_move_target = yes
                    }
                    PREV = {
                        capital_scope = {
                            ROOT = {
                                set_fleet_flag = enroute_to_capital@PREV
                                auto_move_to_planet = {
                                    target = PREV
                                    clear_auto_move_on_arrival = no
                                    arrival_effect = deposit_cargo_at_colony
                                }
                            }
                        }
                    }
                }
                else = {
                    closest_system = {
                        limit = {
                            exists = space_owner
                            space_owner = { is_same_value = PREVPREVPREV }
                            OR = {
                                any_system_planet = {
                                    is_colony = yes
                                    exists = owner
                                    owner = { is_same_value = PREVPREVPREVPREV }
                                    NOT = { has_orbital_bombardment = yes }
                                    controller = { is_same_value = PREV.owner }
                                }
                                AND = {
                                    ROOT = { NOT = { has_fleet_flag = hub_freighter }}
                                    exists = starbase
                                    starbase = {
                                        has_starbase_module = trading_hub
                                        exists = owner
                                        owner = { is_same_value = PREVPREVPREVPREV }
                                        controller = { is_same_value = PREV.owner }
                                    }
                                }
                            }
                        }
                        random_system_planet = {
                            limit = {
                                OR = {
                                    AND = {
                                        is_colony = yes
                                        NOT = { has_orbital_bombardment = yes }
                                        controller = { is_same_value = PREV.owner }
                                    }
                                    AND = {
                                        is_primary_star = yes
                                        solar_system = {
                                            starbase = {
                                                has_starbase_module = trading_hub
                                                controller = { is_same_value = PREV.owner }
                                            }
                                        }
                                    }
                                }
                            }
                            weights = {
                                base = 1
                                modifier = {
                                    mult = 0
                                    is_primary_star = yes
                                    solar_system = {
                                        any_system_planet = {
                                            is_colony = yes
                                            exists = owner
                                            owner = { is_same_value = PREVPREVPREVPREV }
                                            NOT = { has_orbital_bombardment = yes }
                                            controller = { is_same_value = PREV.owner }
                                        }
                                    }
                                }
                            }
                            ROOT = {
                                set_timed_fleet_flag = {
                                    flag = orders_received
                                    days = 120
                                }
                                if = {
                                    limit = {
                                        NOR = {
                                            has_fleet_flag = enroute_to_colony@PREV
                                            has_fleet_flag = enroute_to_starbase@PREV
                                            has_fleet_flag = enroute_to_capital@PREV
                                        }
                                    }
                                    if = {
                                        limit = {
                                            any_system = {
                                                any_system_planet = {
                                                    ROOT = {
                                                        OR = {
                                                            has_fleet_flag = enroute_to_colony@PREV
                                                            has_fleet_flag = enroute_to_starbase@PREV
                                                            has_fleet_flag = enroute_to_capital@PREV
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                        random_planet = {
                                            limit = {
                                                ROOT = {
                                                    OR = {
                                                        has_fleet_flag = enroute_to_colony@PREV
                                                        has_fleet_flag = enroute_to_starbase@PREV
                                                        has_fleet_flag = enroute_to_capital@PREV
                                                    }
                                                }
                                            }
                                            ROOT = {
                                                remove_fleet_flag = enroute_to_colony@PREV
                                                remove_fleet_flag = enroute_to_starbase@PREV
                                                remove_fleet_flag = enroute_to_capital@PREV
                                            }
                                        }
                                    }
                                    

                                    if = {
                                        limit = { has_auto_move_target = yes }
                                        remove_auto_move_target = yes
                                    }

                                    if = {
                                        limit = {
                                            PREV = { is_primary_star = yes }
                                        }
                                        set_fleet_flag = enroute_to_starbase@PREV
                                        auto_move_to_planet = {
                                            target = PREV
                                            clear_auto_move_on_arrival = no
                                            arrival_effect = deposit_cargo_at_starbase
                                        }
                                    }
                                    else = {
                                        if = {
                                            limit = { PREV = { is_capital = yes }}
                                            set_fleet_flag = enroute_to_capital@PREV
                                        }
                                        else = { set_fleet_flag = enroute_to_colony@PREV }
                                        auto_move_to_planet = {
                                            target = PREV
                                            clear_auto_move_on_arrival = no
                                            arrival_effect = deposit_cargo_at_colony
                                        }
                                    }
                                }
                            }
                        }
                    }
                }  
            }
        }
    }
}

#called by effect deposit_cargo_at_colony
fleet_event = {
    id = iicso.504
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        delete_fleet = THIS
    }
}