namespace = iicso

#called by yearly pulse gate event (semi-annually)
country_event = {
    id = iicso.500
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        #log = "iicso.500 triggered, sending event to mining stations/hubs"
        every_planet = {
            limit = {
                NOT = { has_planet_flag = running_freighters }
                OR = {
                    AND = {
                        has_mining_station = yes
                        has_stockpile = yes
                    }
                    AND = {
                        is_primary_star = yes
                        has_stockpile = yes
                        solar_system = { exists = starbase }
                    }
                }
            }
            planet_event = {
                id = iicso.501
                days = 1
                random = 179
            }
        }
    }
}

#called by iicso.500, calls itself
planet_event = {
    id = iicso.501
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        #log = "system freighters triggered at [THIS.GetName] for empire [THIS.solar_system.space_owner.GetName]"
        if = {
            limit = {
                solar_system = {
                    starbase = {
                        controller = { is_same_value = PREV.owner }
                    }
                }
            }
            if = {
                limit = { has_sufficient_stockpile = yes }
                random_country = {
                    limit = { has_country_flag = iicso_faction_of@PREV.space_owner }
    
                    if = {
                        limit = {
                            ROOT = {
                                is_primary_star = yes
                                solar_system = {
                                    starbase = { has_starbase_module = trading_hub }
                                }
                            }
                        }
                        create_fleet = {
                            name = hub_freighter_fleet
                            effect = {
                                set_owner = PREV
                                create_station_freighter_ships = yes
                                set_location = PREVPREV
                                set_fleet_flag = hub_freighter
                            }
                        }
                    }
                    else_if = {
                        limit = { ROOT = { is_primary_star = yes }}
                        create_fleet = {
                            name = system_freighter_fleet
                            effect = {
                                set_owner = PREV
                                create_station_freighter_ships = yes
                                set_location = PREVPREV
                                set_fleet_flag = system_freighter
                            }
                        }
                    }
                    else = {
                        create_fleet = {
                            name = station_freighter_fleet
                            effect = {
                                set_owner = PREV
                                create_station_freighter_ships = yes
                                set_location = PREVPREV
                                set_fleet_flag = station_freighter
                            }
                        }
                    }
                    last_created_fleet = {
                        set_fleet_stance = evasive
                        set_timed_fleet_flag = {
                            flag = orders_received
                            days = 90
                        }
                        if = {
                            limit = {
                                ROOT = {
                                    is_primary_star = yes
                                }
                            }
                            fleet_event = {
                                id = iicso.503
                                days = 5
                                random = 10
                            }
                        }
                        else = {
                            fleet_event = {
                                id = iicso.502
                                days = 5
                                random = 10
                            }
                        }
                    }
                }
            }
    
            set_timed_planet_flag = {
                flag = running_freighters
                days = 180
            }
            planet_event = {
                id = iicso.501
                days = 180
            }
        }
    }
}

#called by iicso.501, fleet auto move arrival (deactivated)
fleet_event = {
    id = iicso.502
    is_triggered_only = yes
    hide_window = yes

    trigger = {
        exists = FROM
    }

    immediate = {
        solar_system = {
            if = {
                limit = {
                    any_system_planet = {
                        is_colony = yes
                        controller = { is_same_value = PREV.owner }
                        NOT = { has_orbital_bombardment = yes }
                    }
                }
                
                random_system_planet = {
                    limit = {
                        is_colony = yes
                        controller = { is_same_value = PREV.owner }
                        NOT = { has_orbital_bombardment = yes }
                    }
                    weights = {
                        base = 1
                        modifier = {
                            mult = 2
                            is_capital = yes
                        }
                    }
                    ROOT = {
                        set_timed_fleet_flag = {
                            flag = orders_received
                            days = 120
                        }
                        set_fleet_flag = enroute_to_colony@PREV
                        auto_move_to_planet = {
                            target = PREV
                            clear_auto_move_on_arrival = no
                            arrival_effect = deposit_cargo_at_colony
                        }
                    }
                }
            }
            else = {
                random_system_planet = {
                    limit = { is_primary_star = yes }
                    ROOT = {
                        set_timed_fleet_flag = {
                            flag = orders_received
                            days = 120
                        }
                        set_fleet_flag = enroute_to_starbase@PREV
                        auto_move_to_planet = {
                            target = PREV
                            clear_auto_move_on_arrival = no
                            arrival_effect = deposit_cargo_at_starbase
                        }
                    }
                }
            }
        }
    }
}

#called by iicso.501, on entering system fleet
fleet_event = {
    id = iicso.503
    is_triggered_only = yes
    hide_window = yes

    trigger = {
        OR = {
            has_fleet_flag = hub_freighter
            has_fleet_flag = system_freighter
        }
    }

    immediate = {
        random_country = {
            limit = { has_country_flag = iicso_faction_is@ROOT.owner }
            ROOT = {
                closest_system = {
                    limit = {
                        exists = space_owner
                        space_owner = { is_same_value = PREVPREVPREV }
                        OR = {
                            any_system_planet = {
                                is_colony = yes
                                exists = owner
                                owner = { is_same_value = PREVPREVPREVPREV }
                                NOT = { has_orbital_bombardment = yes }
                                controller = { is_same_value = PREV.owner }
                            }
                            AND = {
                                ROOT = { NOT = { has_fleet_flag = hub_freighter }}
                                exists = starbase
                                starbase = {
                                    has_starbase_module = trading_hub
                                    exists = owner
                                    owner = { is_same_value = PREVPREVPREVPREV }
                                    controller = { is_same_value = PREV.owner }
                                }
                            }
                        }
                    }
                    random_system_planet = {
                        limit = {
                            OR = {
                                AND = {
                                    is_colony = yes
                                    NOT = { has_orbital_bombardment = yes }
                                    controller = { is_same_value = PREV.owner }
                                }
                                AND = {
                                    is_primary_star = yes
                                    solar_system = {
                                        starbase = {
                                            has_starbase_module = trading_hub
                                            controller = { is_same_value = PREV.owner }
                                        }
                                    }
                                }
                            }
                        }
                        weights = {
                            base = 1
                            modifier = {
                                mult = 0
                                is_primary_star = yes
                                solar_system = {
                                    any_system_planet = {
                                        is_colony = yes
                                        exists = owner
                                        owner = { is_same_value = PREVPREVPREVPREV }
                                        NOT = { has_orbital_bombardment = yes }
                                        controller = { is_same_value = PREV.owner }
                                    }
                                }
                            }
                        }
                        ROOT = {
                            set_timed_fleet_flag = {
                                flag = orders_received
                                days = 120
                            }

                            if = {
                                limit = {
                                    PREV = { is_primary_star = yes }
                                }
                                set_fleet_flag = enroute_to_starbase@PREV
                                auto_move_to_planet = {
                                    target = PREV
                                    clear_auto_move_on_arrival = no
                                    arrival_effect = deposit_cargo_at_starbase
                                }
                            }
                            else = {
                                set_fleet_flag = enroute_to_colony@PREV
                                auto_move_to_planet = {
                                    target = PREV
                                    clear_auto_move_on_arrival = no
                                    arrival_effect = deposit_cargo_at_colony
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}

#called by effect deposit_cargo_at_colony
fleet_event = {
    id = iicso.504
    is_triggered_only = yes
    hide_window = yes

    immediate = {
        delete_fleet = THIS
    }
}